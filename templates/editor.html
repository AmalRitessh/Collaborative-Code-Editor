<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>c++ Text Editor</title>

    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/theme/material-darker.min.css">

    <style>

    .CodeMirror {
        font-size: 20px; /* Adjust this value to increase or decrease text size */
    }
        body {
        margin: 0;
        font-family: Arial, sans-serif;

        }
        #editorDiv {
            display: flex;
            width: 100%;
          
        }
        #sidebar {
            width: 150px;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            padding: 10px 0;

        }
        .tab {
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border-bottom: 1px solid #34495e;
        }
        .tab:hover {
            background-color: #34495e;
        }
        .tab.active {
            background-color: #1abc9c;
        }
        #ioAreaDiv {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            height: 100;

        }
        #textAreaDiv {
            flex: 2;
            padding: 10px;
            border: 1px solid #ccc;
            min-width: 300px;

        }
        .hidden {
            display: none;
        }
        .retracted {
            flex-grow: 0;
            pointer-events: none;
            display: none;
            
        }
        textarea, select, button {
            display: block;
            width: 100%;
            margin-bottom: 10px;
        }
        #ioAreaDiv, #textAreaDiv {
            transition:  width 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
        }


        #top {
            position: absolute;
            top: 0;
            width: 100%;
            height: 10%;
            padding: 10px;
            text-align: center;
        }

        #bottom {
            position: absolute;
            bottom: 0;
            width: 100%;
            padding: 10px;
            display: flex;
            height: 88%;
        }
    </style>
    
</head>

<body>

    
    
    
    <!-- Create TextArea -->
    
 <div id="editorDiv">
    <div id="top">
        <h1>Editor</h1> 
    </div>
    <div id = bottom>

        <div id="sidebar">
            <div class="tab active" onclick="toggleTab('file')"><img src="/static/img/open-folder.png" style = "width: 30px;"></div>
            <div class="tab" onclick="toggleTab('run')"><img src="/static/img/play.png" style = "width: 30px;"></div>
            <div class="tab" onclick="toggleTab('users')"><img src="/static/img/person.png" style = "width: 30px;"></div>
        </div>

        <div id="ioAreaDiv">

            <div id="file" class="content">
                <button onclick="createFile()">file</button>
                <div class="tab active" onclick="toggleEditor('editor1')">index.py<img src="/static/img/cross.png" onclick="deleteFile(event)" style = "width: 30px;"></div>
            </div>

            <div id="run" class="content hidden">
                <button onclick="fetchData()">Run</button>
                <p>Input:</p>
                <textarea id="inputArea" name="inputArea" rows="10" cols="10"></textarea>
                <p>Output:</p>
                <textarea id="outputArea" name="outputArea" rows="10" cols="10"></textarea>
            </div>

            <div id="users" class="content hidden">
                <p>This is the Users Tab content. Add user-related functionality here.</p>
                <a href="{{ url_for('index')}}">home</a>
            </div>

        </div>

        <div id="textAreaDiv">

            <div id="editor1">
                <textarea id="textEditor1" name="textEditor" rows="100" cols="100">#hello1</textarea>
            </div>

        </div>
        </div>
    </div>
 

 <script>
        let activeTab = "file"; // Tracks the currently active tab
        let isRetracted = false; // Tracks whether ioAreaDiv is retracted
        let editors = {};

        fileExtension = "py";

        function toggleTab(tabId) {
            const ioAreaDiv = document.getElementById("ioAreaDiv");
            const textAreaDiv = document.getElementById("textAreaDiv");
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.content');

            // If clicking the same tab again, toggle retraction
            if (activeTab === tabId) {
                isRetracted = !isRetracted;
                if (isRetracted) {
                    ioAreaDiv.classList.add("retracted");
                    textAreaDiv.style.flexGrow = "100"; 
                     // Expand textAreaDiv to take up more space

                } else {
                    ioAreaDiv.classList.remove("retracted");
                    textAreaDiv.style.flexGrow = "2"; // Reset textAreaDiv to its original size

                }
                return;
            }

            // Otherwise, reset retraction and show the new tab content
            isRetracted = false;
            ioAreaDiv.classList.remove("retracted");
            textAreaDiv.style.flexGrow = "2"; // Reset textAreaDiv size
            // Hide all content and remove active class from all tabs
            contents.forEach(content => content.classList.add("hidden"));
            tabs.forEach(tab => tab.classList.remove("active"));

            // Show the selected tab content and mark the tab as active
            document.getElementById(tabId).classList.remove("hidden");
            event.target.classList.add("active");

            // Update the activeTab variable
            activeTab = tabId;
        }// Track the current state of the ioAreaDiv

        function toggleEditor(editorId) {
            const editorsDiv = document.querySelectorAll('#textAreaDiv > div');
            editorsDiv.forEach(editor => {
                editor.style.display = editor.id === editorId ? 'block' : 'none';
            });
            const tab = document.querySelector(`#file .tab[onclick*="${editorId}"]`);
            if (tab) {
                fileExtension = tab.textContent.split('.').pop();
            }
            currentTextEditor = editors[`textEditor${editorId.split('r').pop()}`][0];
        }


        let fileCount = 1; // Start from the current number of files

        function createFile() {
            const fileName = window.prompt("Enter file name");
            if (!fileName) return; // Exit if no file name is provided

            fileCount++; // Increment the file counter
            const newEditorId = `editor${fileCount}`;

            // Add new tab to the file div
            const fileDiv = document.getElementById('file');
            const newTab = document.createElement('div');
            const image = document.createElement('img');
            image.setAttribute('src', `/static/img/cross.png`);
            image.setAttribute('onclick',`deleteFile(event)`);
            image.setAttribute('style',`width: 30px;`);
            
            newTab.className = "tab active";
            newTab.setAttribute('onclick', `toggleEditor('${newEditorId}')`);
            newTab.textContent = fileName;
            
            newTab.appendChild(image);
            fileDiv.appendChild(newTab);

            // Add new editor to the textAreaDiv
            const textAreaDiv = document.getElementById('textAreaDiv');
            const newEditor = document.createElement('div');
            newEditor.id = newEditorId;

            const newTextArea = document.createElement('textarea');
            newTextArea.id = `textEditor${fileCount}`;
            newTextArea.name = "textEditor";
            newTextArea.rows = 100;
            newTextArea.cols = 100;

            newEditor.appendChild(newTextArea);
            textAreaDiv.appendChild(newEditor);

            let syntaxSelector = {cpp : 'text/x-c++src', py : 'python', plain: 'text/plain' }
            let fileExtension = fileName.split('.').pop();
            if (!(fileExtension in syntaxSelector)){
                fileExtension = 'plain';
            }   

            let editor = [];
            editor.push (CodeMirror.fromTextArea(document.getElementById(`textEditor${fileCount}`), {
                            mode: syntaxSelector[fileExtension],
                            lineNumbers: true,
                            theme: "material-darker",
                            autoCloseBrackets: true,
                            matchBrackets: true,
                            indentUnit: 4,
                            tabSize: 4,
                            smartIndent: true,
                            indentWithTabs: false,
                        }));

            editor.push(fileName);

            editors[`textEditor${fileCount}`] = editor;
            toggleEditor(newEditorId);
        }


        function createFileByRequest(textEditorid, content, fileName) {
    
            let tempCount = textEditorid.split('r').pop()
            const newEditorId = `editor${tempCount}`;

            // Add new tab to the file div
            const fileDiv = document.getElementById('file');
            const newTab = document.createElement('div');
            const image = document.createElement('img');
            image.setAttribute('src', `/static/img/cross.png`);
            image.setAttribute('onclick',`deleteFile(event)`);
            image.setAttribute('style',`width: 30px;`);
            
            newTab.className = "tab active";
            newTab.setAttribute('onclick', `toggleEditor('${newEditorId}')`);
            newTab.textContent = fileName;
            
            newTab.appendChild(image);
            fileDiv.appendChild(newTab);

            // Add new editor to the textAreaDiv
            const textAreaDiv = document.getElementById('textAreaDiv');
            const newEditor = document.createElement('div');
            newEditor.id = newEditorId;

            const newTextArea = document.createElement('textarea');
            newTextArea.id = `textEditor${tempCount}`;
            newTextArea.name = "textEditor";
            newTextArea.rows = 100;
            newTextArea.cols = 100;

            newEditor.appendChild(newTextArea);
            textAreaDiv.appendChild(newEditor);

            let syntaxSelector = {cpp : 'text/x-c++src', py : 'python', plain: 'text/plain' }
            let fileExtension = fileName.split('.').pop();
            if (!(fileExtension in syntaxSelector)){
                fileExtension = 'plain';
            }   

            let editor = [];
            editor.push (CodeMirror.fromTextArea(document.getElementById(`textEditor${tempCount}`), {
                            mode: syntaxSelector[fileExtension],
                            lineNumbers: true,
                            theme: "material-darker",
                            autoCloseBrackets: true,
                            matchBrackets: true,
                            indentUnit: 4,
                            tabSize: 4,
                            smartIndent: true,
                            indentWithTabs: false,
                        }));

            editor.push(fileName);
            editor[0].setValue(content);

            editors[`textEditor${tempCount}`] = editor;
            toggleEditor(newEditorId);
        }

        function deleteFileByRequest(){
            const fileDiv = document.getElementById('file');
            Array.from(fileDiv.children).forEach(child => {
              if (child.tagName === 'DIV') {
                child.remove(); // Remove divs
              }
            });

            // Remove all divs inside #textAreaDiv
            const textAreaDiv = document.getElementById('textAreaDiv');
            while (textAreaDiv.firstChild) {
              textAreaDiv.firstChild.remove();
            }

            editors = {};
        }

        function deleteFile(event) {
            // Prevent triggering parent element's click event
            event.stopPropagation();

            // Find the tab and editor associated with the delete button
            const tabToDelete = event.target.parentElement;
            const editorId = tabToDelete.getAttribute('onclick').match(/'([^']+)'/)[1]; // Extract the editor ID
            console.log(tabToDelete.getAttribute('onclick'));
            const editorToDelete = document.getElementById(editorId);

            // Remove the tab and editor
            tabToDelete.remove();
            editorToDelete.remove();

            delete editors[`textEditor${editorId.split('r').pop()}`]

            // Optionally, handle active tab switching
            const remainingTabs = document.querySelectorAll('#file .tab');
            if (remainingTabs.length > 0) {
                remainingTabs[0].click(); // Activate the first remaining tab
            }
        }



    </script>


    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/edit/matchbrackets.min.js"></script>

    <script>
        let editor = [];
        editor.push(CodeMirror.fromTextArea(document.getElementById('textEditor1'), {
            mode: "python",
            lineNumbers: true,
            theme: "material-darker",
            autoCloseBrackets: true,
            matchBrackets: true,
            indentUnit: 4,
            tabSize: 4,
            smartIndent: true,
            indentWithTabs: false,
        }));

        editor.push("index.py");
        editors[`textEditor1`] = editor;

        currentTextEditor = editors[`textEditor1`][0];

        var outputArea = CodeMirror.fromTextArea(document.getElementById('outputArea'), {
            mode: "text/plain",
            lineNumbers: false,
            theme: "material-darker",
        });

        var inputArea = CodeMirror.fromTextArea(document.getElementById('inputArea'), {
            mode: "text/plain",
            lineNumbers: false,
            theme: "material-darker",
        });
    </script>
    <script>
        async function fetchData() {
        console.log("fetchdata");
        console.log(typeof currentTextEditor)
        console.log(currentTextEditor.getValue())
        console.log(typeof textEditor)
        const code = currentTextEditor.getValue();
        const input = inputArea.getValue();

        console.log(code,input,fileExtension);
        const response = await fetch('/compile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({codeVal:code,inputVal:input,langType:fileExtension}),
        });

        const data = await response.json();
        outputArea.setValue(data.result);
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.js"></script>
    <script>
        const socket = io();
        const room_id = "{{ room_id }}";

        // Join the room
        if (!window.hasRunOnce) {
            window.hasRunOnce = true;
            socket.emit('join', { room: room_id });    
        }

        socket.on('request_editors', (data) => {
            console.log("request_editorst");
            let currentEditors = [];
            for(let [key, values] of Object.entries(editors)){
                let temp = [];
                temp.push(key)
                temp.push(values[0].getValue());
                temp.push(values[1]);
                currentEditors.push(temp);
            }
            console.log(currentEditors)
            if(!(currentEditors.length === 1 && 
          currentEditors[0][1] === "#hello1" && 
          currentEditors[0][2] === "index.py")){
                socket.emit('requested_editors', { room: room_id, currentEditors, fileCount});
            }
            
        });

        socket.on('create_editors', (data) => {
            console.log("create_editors");
            deleteFileByRequest();
            fileCount = data.fileCount;
            if (data.room === room_id){
                for(let sublist of data.currentEditors){
                    createFileByRequest(sublist[0],sublist[1],sublist[2]);
                }
            }
        });

        // Respond to request for text
        socket.on('request_text', (data) => {
            if (data.room === room_id) {
                const text = textEditor.getValue();
                if(text!=""){
                    socket.emit('update_text', { room: room_id, text });    
                }  
            }
        });


        let isProgrammaticChange = false;
        // Receive and update editor text
        socket.on('update_text', (data) => {
            isProgrammaticChange = true;
            const cursor = textEditor.getCursor();
            textEditor.setValue(data.text);
            textEditor.setCursor(cursor);
            isProgrammaticChange = false;
        });

        // Send updates to the server on input change
        textEditor.on('change', () => {
            if (isProgrammaticChange) return;
            const text = textEditor.getValue();
            socket.emit('update_text', { room: room_id, text });
        });

    </script>

</body>
</html>
